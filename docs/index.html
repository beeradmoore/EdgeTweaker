<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
</head>

<body>
    <div class="container" id="main-container">
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">EdgeTweaker</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <!--
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="#">Import settings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="#">Save settings</a>
                        </li>
                        -->
                    </ul>
                    <form class="d-flex" role="search">
                        <input class="form-control me-2" id="search-box" type="search" placeholder="Search"
                            aria-label="Search" disabled />
                    </form>
                </div>
            </div>
        </nav>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script type="text/javascript">
        var jsonData;

        document.addEventListener(
            "DOMContentLoaded",
            function () {
                const mainContainer = document.getElementById("main-container");

                const searchBox = document.getElementById("search-box");
                const searchHandler = function (e) {
                    //const cards = document.getElementsByClassName("card");

                    if (e.target.value == "") {
                        Object.keys(jsonData.policy_groups).forEach(function (
                            policyGroupsKey
                        ) {
                            const policyGroup = jsonData.policy_groups[policyGroupsKey];

                            // Show cardDiv again
                            Object.keys(policyGroup.policies).forEach(function (policyKey) {
                                const policy = policyGroup.policies[policyKey];
                                policy.cardDiv.classList.remove("d-none");
                            });

                            // Show the policyRow again
                            policyGroup.policyRow.classList.remove("d-none");
                        });
                    } else {
                        var lowerSearchValue = e.target.value.toLowerCase();

                        Object.keys(jsonData.policy_groups).forEach(function (
                            policyGroupsKey
                        ) {
                            const policyGroup = jsonData.policy_groups[policyGroupsKey];

                            var allHidden = true;

                            // Hide cardDiv if it matches the search filter
                            Object.keys(policyGroup.policies).forEach(function (policyKey) {
                                const policy = policyGroup.policies[policyKey];

                                var searchTerms = [
                                    policy.name.toLowerCase(),
                                    policy.summary.toLowerCase(),
                                ];

                                for (let i = 0; i < searchTerms.length; ++i) {
                                    if (searchTerms[i].indexOf(lowerSearchValue) === -1) {
                                        // Search term was not found, so hide the card
                                        policy.cardDiv.classList.add("d-none");
                                    } else {
                                        // Search term was found, so re-show the card in case it was hidden)
                                        policy.cardDiv.classList.remove("d-none");

                                        // There is at least 1 visible card, so we want to ensure the row is shown.
                                        allHidden = false;

                                        // I hope this breaks the for loop
                                        break;
                                    }
                                }
                            });

                            if (allHidden == true) {
                                // Hide the policyRow if all cardDivs were hidden.
                                policyGroup.policyRow.classList.add("d-none");
                            } else {
                                // Show the policyRow if not all of cardDivs were hidden.
                                policyGroup.policyRow.classList.remove("d-none");
                            }
                        });
                    }
                };
                searchBox.addEventListener("input", searchHandler);

                var httpRequest = new XMLHttpRequest();
                httpRequest.onreadystatechange = function () {
                    if (httpRequest.readyState === 4) {
                        if (httpRequest.status === 200) {
                            jsonData = JSON.parse(httpRequest.responseText);

                            Object.keys(jsonData.policy_groups).forEach(function (
                                policyGroupsKey
                            ) {
                                const policyGroup = jsonData.policy_groups[policyGroupsKey];

                                const policyRow = document.createElement("div");
                                policyRow.classList.add("row");
                                policyRow.classList.add("mt-4");

                                policyGroup.policyRow = policyRow;

                                const policyGroupHeading = document.createElement("h2");
                                policyGroupHeading.id = policyGroup.link;
                                policyGroupHeading.appendChild(
                                    document.createTextNode(policyGroup.name)
                                );
                                policyRow.appendChild(policyGroupHeading);

                                const policyGroupDiv = document.createElement("div");
                                policyGroupDiv.classList.add("d-flex");
                                policyGroupDiv.classList.add("flex-wrap");
                                policyGroupDiv.classList.add("gap-3");

                                Object.keys(policyGroup.policies).forEach(function (
                                    policyKey
                                ) {
                                    const policy = policyGroup.policies[policyKey];
                                    console.log(policy);

                                    const cardDiv = document.createElement("div");
                                    cardDiv.classList.add("card");
                                    cardDiv.style = "width: 18rem;";

                                    policy.cardDiv = cardDiv;

                                    const cardBody = document.createElement("div");
                                    cardBody.classList.add("card-body");

                                    const cardBodyHeader = document.createElement("h5");
                                    cardBodyHeader.classList.add("card-title");
                                    cardBodyHeader.appendChild(
                                        document.createTextNode(policy.name)
                                    );

                                    const cardBodySummary = document.createElement("p");
                                    cardBodySummary.classList.add("card-text");
                                    cardBodySummary.appendChild(
                                        document.createTextNode(policy.summary)
                                    );

                                    cardBody.appendChild(cardBodyHeader);
                                    cardBody.appendChild(cardBodySummary);

                                    cardDiv.appendChild(cardBody);

                                    policyGroupDiv.appendChild(cardDiv);
                                });

                                policyRow.appendChild(policyGroupDiv);

                                mainContainer.appendChild(policyRow);
                            });

                            searchBox.removeAttribute("disabled");
                        }
                    }
                };
                httpRequest.open("GET", "policy-groups.json");
                httpRequest.send();
            },
            false
        );
    </script>
</body>

</html>